<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./ram-state.js"></script>

    <style>
        .cursor-pointer {
            cursor: pointer;
        }

        .completed {
            text-decoration: line-through;
        }
    </style>
</head>

<body>
    <div class="container pt-3">

        <h1 class="text-center text-primary">RamState Demo</h1>

        <h4 class="text-center mb-3">TODO</h4>

        <!-- Input -->
        <input type="text" class="form-control border border-secondary mb-2" placeholder="Enter task" id="inputTask">

        <!-- Controls -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <b>Count: <span id="todoCount"></span></b>
            <select class="form-select w-auto" onchange="filterBy.set(this.value)">
                <option value="all">All</option>
                <option value="ongoing">Todo</option>
                <option value="completed">Completed</option>
            </select>
        </div>

        <!-- Task list -->
        <ul id="todoList" class="list-group"></ul>

    </div>
</body>
<script>
    const { useState, useEffect } = RamState();

    const todo = useState([]);
    const filterBy = useState('all');

    document.getElementById('inputTask').addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && e.target.value?.trim() !== '') {
            todo.set(list => [...list, {
                id: ((todo.get().at(-1)?.id) || 0) + 1,
                task: e.target.value.trim(),
                completed: false
            }]);
            e.target.value = '';
        }
    });

    function removeTask(id) {
        todo.set(list => list.filter(item => item.id !== id));
    }

    function toggleCompleted(id) {
        todo.set(list => list.map(item => item.id === id ? { ...item, completed: !item.completed } : item));
    }

    useEffect(() => {

        const totalCompleted = todo.get().filter(item => item.completed).length;

        document.getElementById('todoCount').textContent = `${totalCompleted}/${todo.get().length}`;

        let filteredList = [...todo.get()].filter(item => {
            if (filterBy.get() === 'completed') return item.completed;
            if (filterBy.get() === 'ongoing') return !item.completed;
            return true;
        });

        document.getElementById("todoList").innerHTML = filteredList.length ?
            filteredList.map(item => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="cursor-pointer ${item.completed ? 'completed' : ''}" onclick="toggleCompleted(${item.id})">
                        ${item.id}. ${item.task}
                    </span>
                    <button class="btn-close" onclick="removeTask(${item.id})"></button>
                </li>`).join('') : `<li class="list-group-item text-muted">No tasks</li>`;

    }, [todo, filterBy]);

</script>

</html>