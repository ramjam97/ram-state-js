<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ramstatejs -->
    <script src="../dist/ram-state.min.js"></script>
    <style>
        .cursor-pointer {
            cursor: pointer;
        }

        .completed {
            text-decoration: line-through;
        }
    </style>
</head>

<body class="container pt-3">

    <h1 class="text-center text-primary">RamStateJs Demo</h1>

    <h4 class="text-center mb-3">TODO</h4>

    <!-- Input -->
    <input type="text" class="form-control border border-secondary mb-2" placeholder="Enter task" id="inputTask">

    <!-- Controls -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <b>Count: <span id="todoCount"></span></b>
        <select class="form-select w-auto" id="filterBy">
            <option value="all">All</option>
            <option value="active">Active</option>
            <option value="completed">Completed</option>
        </select>
    </div>

    <!-- Task list -->
    <ul id="todoList" class="list-group mb-3"></ul>

    <button class="btn btn-danger" id="clearBtn">Clear State</button>

</body>
<script>
    const { useState, useEffect, useButton, useMemo } = RamState();

    const todo = useState([]);
    const filterBy = useState('active', "#filterBy");
    const id = useState(1);

    document.getElementById('clearBtn').addEventListener('click', (e) => {

        const { loading } = useButton(e.target, { loading: { icon: "⏳" } });
        loading();

        filterBy.set('active');
        todo.set([]);

        setTimeout(() => loading(false), 1000);
    });

    const filteredTodo = useMemo(() => {

        console.log('%cuseMemo [filteredTodo]', 'color:red', { todo: todo.value.length, filterBy: filterBy.value });

        if (filterBy.value === 'all') return todo.value;
        if (filterBy.value === 'active') return todo.value.filter(item => !item.completed);
        if (filterBy.value === 'completed') return todo.value.filter(item => item.completed);
        return [];

    }, [todo, filterBy]);

    const completedTodo = useMemo(() => {

        console.log('%cuseMemo [completedTodo]', 'color:green', { todo: todo.value.length, filterBy: filterBy.value });

        return todo.value.filter(item => item.completed);
    }, [todo]);

    useEffect(() => {
        console.log('%cuseEffect', 'color:yellow', { todo: todo.value.length, filterBy: filterBy.value });
    }, [todo, filterBy]);

    filteredTodo.watchEffect(({ value }) => {

        console.log('%cwatchEffect [filteredTodo]', 'color:orange', { todo: todo.value.length, filterBy: filterBy.value });

        const totalCompleted = todo.value.filter(item => item.completed).length;

        document.getElementById("todoList").innerHTML = value.length ?
            value.map(item => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="cursor-pointer ${item.completed ? 'completed' : ''}" onclick="toggleCompleted(${item.id})">
                        ${item.id}. ${item.task}
                        </span>
                        <button class="btn-close" onclick="removeTask(${item.id})"></button>
                        </li>`).join('')
            : `<li class="list-group-item text-muted">No tasks</li>`;
    });

    completedTodo.watchEffect((cntxt) => {
        console.log('%cwatchEffect [completedTodo]', 'color:orange', cntxt);
        document.getElementById('todoCount').textContent = `${cntxt.value.length}/${todo.value.length}`;
    });

    document.getElementById('inputTask').addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && e.target.value?.trim() !== '') {
            todo.set(list => [...list, {
                id: id.value,
                task: e.target.value.trim(),
                completed: false
            }]);
            id.set(v => v + 1);
            e.target.value = '';
        }
    });

    console.log('filterBy Effects:', filterBy);

    function removeTask(id) {
        todo.set(list => list.filter(item => item.id !== id));
    }

    function toggleCompleted(id) {
        todo.set(list => list.map(item => item.id === id ? { ...item, completed: !item.completed } : item));
    }
</script>

</html>