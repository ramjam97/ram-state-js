<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ramstatejs -->
    <script src="../dist/ram-state.min.js"></script>
</head>

<body>
    <div class="container py-3">

        <div class="d-flex flex-column gap-2">

            <h1 class="text-center text-primary">RamState Demo</h1>

            <input type="search" class="form-control" placeholder="search item.." id="searchInput">

            <span class="fw-bold">Records: <span id="foundCount"></span>/<span id="totalCount"></span></span>

            <ul class="list-group" id="productsList"></ul>

            <button class="btn btn-primary" id="loadMoreBtn" onclick="fetchQuotes()">Load more</button>
        </div>
    </div>
</body>
<script>
    const { useState, useMemo, useEffect, useButton } = RamState();

    const lastId = useState(0);
    const products = useState([]);
    const search = useState('', '#searchInput');
    const totalCount = useState(0, '#totalCount');
    const foundCount = useState(0, '#foundCount');
    const filteredProducts = useMemo(() => {
        return products.value.filter(product => product.title.toLowerCase().includes(search.value.toLowerCase()));
    }, [products, search]);

    const loadMoreBtn = useButton('#loadMoreBtn', {
        loading: { icon: ' <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>' }
    });

    const removeProduct = (id) => products.set(list => list.filter(item => item.id !== id));

    function fetchQuotes() {
        loadMoreBtn.loading();
        fetch(`https://dummyjson.com/products?limit=10&skip=${lastId.value}`)
            .then(response => response.json())
            .then(data => products.set(list => [...list, ...data.products]))
            .catch(error => console.error('Error fetching quotes:', error))
            .finally(() => loadMoreBtn.loading(false));
    }

    products.watchEffect(({ value }) => {
        lastId.set(value[value.length - 1]?.id ?? 0);
        totalCount.set(value.length);
    }, true);

    filteredProducts.watch(({ value }) => {
        foundCount.set(value.length);
        document.getElementById('productsList').innerHTML = value.length > 0
            ? value.map((item) => `
            <li id="product-${item.id}" class="product-item list-group-item d-flex flex-row gap-3 position-relative">
                <img src="${item.images[0]}" class="rounded bg-light" width="100" height="100">
                <div class="d-flex flex-column">
                    <h5 class="text-primary">#${item.id}</h5>    
                    <span class="fw-bold">${item.title}</span>    
                    <span>${item.description}</span>    
                </div>
                <span class="position-absolute top-0 end-0 p-2">
                    <button class="btn-close" onclick="removeProduct(${item.id})"></button>
                </span>
            </li>`).join('') : `<li class="list-group-item text-muted">No records found</li>`;
    });

    useEffect(() => {
        fetchQuotes();
    }, []);

</script>

</html>