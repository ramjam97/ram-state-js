<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ramstatejs -->
    <script src="../dist/ram-state.js"></script>
</head>

<body>
    <div class="container py-3 pb-5">

        <div class="d-flex flex-column gap-2">

            <h1 class="text-center text-primary">RamState Demo</h1>

            <div class="d-flex flex-row justify-content-between flex-wrap gap-3">
                <div class="d-flex flex-row gap-2 align-items-center">
                    <label class="fw-bold">Catergoy:</label>
                    <select id="categorySelect" class="form-select">
                        <option value="" selected>All</option>
                    </select>
                </div>
                <div class="d-flex flex-row gap-2 align-items-center">
                    <label class="fw-bold">Search:</label>
                    <input type="search" class="form-control" placeholder="search item.." id="searchInput">
                </div>
            </div>

            <span class="fw-bold">
                Records:
                <span id="filteredCount"></span>/<span id="totalFetch"></span>
                of
                <span id="totalCount"></span>
            </span>

            <span class="text-muted card p-2" id="message"></span>
            <ul class="list-group" id="productsList"></ul>

            <button class="btn btn-primary" id="loadMoreBtn" onclick="fetchProducts()">Load more</button>
        </div>
    </div>
</body>
<script>
    const { useState, useMemo, useEffect, useButton, useDisplay } = RamState();

    const products = useState([]);
    const categories = useState([]);
    const search = useState('', '#searchInput');
    const category = useState('', '#categorySelect');

    const messageDiv = useDisplay(false, '#message');
    const message = useState('', '#message');
    const totalFetch = useState(0, '#totalFetch');
    const totalCount = useState(0, '#totalCount');

    const filteredProducts = useMemo(() => {
        return products.value.filter(product => product.title.toLowerCase().includes(search.value.toLowerCase()));
    }, [products, search]);

    const loadMoreBtn = useButton('#loadMoreBtn', {
        loading: { icon: ' <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>' }
    });

    const removeProduct = (id) => products.set(list => list.filter(item => item.id !== id));

    function fetchProducts(newList = false) {
        loadMoreBtn.loading();

        const limit = 10;
        const skip = newList ? 0 : (products.value.length / limit) * limit;

        let endpoint = `https://dummyjson.com/products`;
        if (category.value !== '') {
            endpoint = `https://dummyjson.com/products/category/${category.value}`;
        }

        fetch(`${endpoint}?limit=${limit}&skip=${skip}`)
            .then(response => response.json())
            .then(data => {
                if (newList) {
                    products.set(data.products);
                } else {
                    products.set(list => [...list, ...data.products]);
                }
                totalCount.set(data.total);
                loadMoreBtn.show(products.value.length < data.total);
            })
            .catch(error => console.error('Error fetching products:', error))
            .finally(() => loadMoreBtn.loading(false));
    }

    products.watchEffect(() => {
        totalFetch.set(products.value.length);
    }, true);

    let categotyChangeTimeout = null;
    useEffect(() => {
        loadMoreBtn.loading();
        categotyChangeTimeout = setTimeout(() => {
            fetchProducts(true);
        }, 500);
        return () => {
            clearTimeout(categotyChangeTimeout);
            categotyChangeTimeout = null;
        }
    }, [category]);


    function getStarRating(rating) {
        return [
            ...Array.from({ length: Math.floor(rating) }).map(() => `<i class="fa-solid fa-star text-warning"></i>`),
            !Number.isInteger(rating) ? `<i class="fa-solid fa-star-half text-warning"></i>` : ''
        ].join('');
    }

    filteredProducts.watch(({ value }) => {

        document.getElementById('filteredCount').innerHTML = value.length;
        document.getElementById('productsList').innerHTML = value.map((item, index) => `
            <li id="product-${item.id}" class="product-item list-group-item d-flex flex-row gap-3 position-relative">
                <img src="${item.images[0]}" class="rounded bg-light" width="150" height="150">
                <div class="d-flex flex-column">
                    <h5 class="text-primary">#${item.id}</h5>    
                    <span class="fw-bold">${item.title}</span>    
                    <span>$${item.price}</span>    
                    <span>${item.description}</span>
                    <span>Rate: ${item.rating}</span>
                    <span>${getStarRating(item.rating)}</span>
                </div>
                <span class="position-absolute top-0 start-0 p-2 text-muted">
                    ${index + 1}
                </span>
                <span class="position-absolute top-0 end-0 p-2">
                    <button class="btn-close" onclick="removeProduct(${item.id})"></button>
                </span>
            </li>`).join('');

    });

    useEffect(() => {

        messageDiv.show(filteredProducts.value.length === 0 || loadMoreBtn.value.loading);
        message.set(
            loadMoreBtn.value.loading ? 'Loading...' :
                filteredProducts.value.length === 0 ? 'No records found' : ''
        );

    }, [filteredProducts, loadMoreBtn]);

    categories.watchEffect(({ value }) => {
        console.log('category.value:', category.value);
        console.log('categories.value:', value);
        document.getElementById('categorySelect').innerHTML = [
            `<option value="" ${category.value === '' ? 'selected' : ''}>All</option>`,
            ...value.map(item => `<option value="${item.slug}" ${category.value === item.slug ? 'selected' : ''}>
                    ${item.name}
                </option>`)
        ].join('');
    }, true);

    useEffect(() => {
        fetch(`https://dummyjson.com/products/categories`)
            .then(response => response.json())
            .then(data => categories.set(list => [...list, ...data]))
    }, []);

</script>

</html>